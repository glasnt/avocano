# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on PR
'on': pull_request

jobs:
  build_and_preview:
    if: '${{ github.event.pull_request.head.repo.full_name == github.repository }}'
    runs-on: ubuntu-latest
    
    #permissions:
    #  contents: 'read'
    #  id-token: 'write'
    #  pull-requests: write

    # Auth to Google Cloud
    steps:
    - uses: actions/checkout@v2
    - id: 'auth'
      uses: 'google-github-actions/auth@v0'
      with:
        workload_identity_provider: ${{ secrets.WIF_IDENTITY }}
        service_account:  ${{ secrets.WIF_SERVICE_ACCOUNT }}

    # Do Google Cloud things
    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v0'

    - name: 'Deploy backend api'
      run: |
          gcloud builds submit \
            --config provisioning/server-preview.cloudbuild.yaml \
            --substitutions _PR_TAG=pr-${{ github.event.pull_request.number }} || true

    # Update Firebase config for new service
    - name: Update service
      run: | 
        cd client
        grep serviceId firebase.json
        sed -i 's/"api"/"api-pr-${{ github.event.pull_request.number }}"/g' firebase.json
        grep serviceId firebase.json

    # Do Firebase things (auth through secret)
    - name: Build frontend client
      run:  cd client && npm i --omit dev && npm run build

    - name: Deploy frontend client
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        entrypoint: client
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_AVOCANO_PREVIEW }}'
        projectId: avocano-preview
